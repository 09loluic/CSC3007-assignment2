<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://code.jquery.com/jquery-1.9.1.min.js"></script>

</head>
<body>



<div >
<label for="yearDropDown" class="visually-hidden">Select Year: </label>
<select id="yearDropDown" name="Year" onchange="loadChart()"></select>
</div>
<div id="my_dataviz"></div>

</body>
</html>

<script>
    d3.select("#hellos p").style("color", "red");
    d3.selectAll("#hellos p").style("color", "blue");

    let OriginalData = [];
  
    let yearList = [];
    
// let data = [
//     {cx: 400, cy: 600, r:150, fill: "green", stroke: "black"},
//     {cx: 100, cy: 200, r:50, fill: "blue", stroke: "purple"},
//     {cx: 650, cy: 100, r:100, fill: "red", stroke: "orange"}
// ]
// let hellos = d3.select("#hellos");
// let xScale = d3.scaleLinear()
//     .domain([0,1000])
//     .range([0,600]);

// let yScale = d3.scaleLinear()
//     .domain([0,1000])
//     .range([600,0]);
// hellos.selectAll("p")
// .data(data)
// .enter()
// .append("svg")
// .attr("cx", d => d.cx)
// .attr("cy", d => d.cy)
// .attr("fill", d => d.fill)
// .attr("stroke", d => d.stroke)
// .style("font-size", d => d.size + "px")
// .style("color", d=>d.color)
// .style("font-family",d=>d.font)
// .text(d => d.text)
// .transition()
// .duration((d,i) => {console.log(d,1); return 1000})

// $(document).ready(function(){
        
var data = {
  resource_id: '83c21090-bd19-4b54-ab6b-d999c251edcf', // the resource id
};

$.ajax({
  url: 'https://data.gov.sg/api/action/datastore_search',
  contentType: "application/json",
dataType: "json",
data:data,
  success: function(datas) {
    
  OriginalData  = datas["result"]["records"];
  console.log("Original Data: " + JSON.stringify(OriginalData)) ;

var option = '';
$.each(OriginalData, function(key,value) {

   if(jQuery.inArray(value["year"], yearList) == -1)
   {
      yearList.push(value["year"]);
      option += '<option value="'+ value["year"] + '" >' + value["year"] + '</option>';
   }
       
}); 

var dropdown = $("#yearDropDown");
dropdown.append(option);
// var barData = [];
// var barChartData = [];

// $.each(OriginalData, function(key,value) {


//     if (!barData.hasOwnProperty("" +value["year"])){

//         barData["" + value["year"]] = {};
//     }
    
//     barData["" + value["year"]][value["level_2"]]  = value["value"];
//     console.log("There are "  + value["value"] + " "+ value["level_2"]+" case in " +value["year"]);  
       
// }); 


// $.each(barData, function(key,value) {

// var  item = {}

// item["year"] = key;
// item["title"] = key;
// if(barData.hasOwnProperty(key)){

//     var subItem = new Array();
//     $.each(barData[key], function(keys,values) {

//     item[keys] = values; 
//     subItem.push(keys);
//   }
 
//   );
// item["DataTitle"] = subItem;
// console.log(barData[key]);
// barChartData.push(item);
// }

// // barData["" + value["year"]][value["level_2"]]  = value["value"];
// // console.log("There are "  + value["value"] + " "+ value["level_2"]+" case in " +value["year"]);  
   
// }); 

loadChart();
   }
                
   })


  
function filterData(){

  var year = $('#yearDropDown').val();
     var returnData = []  
     $.each(OriginalData, function(key,value) {

      console.log("Year " + value["year"] + " Looking Year:" + year)
      if(value["year"]== year){
        // OriginalData[key]["value"] = (OriginalData[key]["value"]/10)
      returnData.push(OriginalData[key]);
      }

    })
    return returnData;
  }

   
function loadChart(){
  $("#my_dataviz").html("");
  var barChartData = filterData();
  var margin = {top: 30, right: 30, bottom: 70, left: 60},
  width = 460 - margin.left - margin.right,
  height = 400 - margin.top - margin.bottom;

// append the svg object to the body of the page
var svg = d3.select("#my_dataviz")
  .append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform",
          "translate(" + margin.left + "," + margin.top + ")");


          
  var tip = d3.tip()
  .attr('class', 'tooltip')
  .html(d => '<div>${d.value}</div>');
// X axis
var x = d3.scaleBand()
  .range([ 0, width ])
  .domain(barChartData.map(function(d) { return d["level_2"]; }))
  .padding(0.2);

svg.append("g")
  .attr("transform", "translate(0," + height + ")")
  .call(d3.axisBottom(x))
  .selectAll("text")
    .attr("transform", "translate(-10,0)rotate(-45)")
    .style("text-anchor", "end");

// Add Y axis
var y = d3.scaleLinear()
  .domain([0, 1000])
  .range([ height, 0]);

svg.append("g")
  .call(d3.axisLeft(y));

// Bars
svg.selectAll("mybar")
  .data(barChartData)
  .enter()
  .append("rect")
    .attr("x", function(d) { return x(d["level_2"]); })
    .attr("y", function(d) { return y(d["value"]); })
    .attr("width", x.bandwidth())
    .attr("height", function(d) { return height - y(d["value"]); })
    .attr("fill", "#69b3a2")
    .on('mouseover', (d) => {
      tip.show(d);
    })
}

</script>
